(function(){var AutoOptions,Bit,RowWrapper,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key]}function ctor(){this.constructor=child}ctor.prototype=parent.prototype;child.prototype=new ctor;child.__super__=parent.prototype;return child},hasProp={}.hasOwnProperty;AutoOptions=function(){function AutoOptions(options){var key,val;if(options==null){options={}}for(key in options){val=options[key];if(val!=null){this[key]=val}}}return AutoOptions}();Bit=function(){Bit.prototype._currentValue=[];Bit.prototype._data=[];Bit.prototype.data=function(index){if(this._data[index]!=null){return this._data[index]}else{return 0}};Bit.prototype.currentValue=function(index){if(this._currentValue[index]){return this._currentValue[index]}else{return 0}};function Bit(countMax){this.countMax=countMax!=null?countMax:1e4}Bit.prototype.setValue=function(index,value){var results;index++;value-=this.currentValue(index);this._currentValue[index]=value;results=[];while(index<this.countMax){this._data[index]=this.data(index)+value;results.push(index+=index&-index)}return results};Bit.prototype.getSum=function(index){var sum;sum=0;index++;while(index>0){sum+=this.data(index);index-=index&-index}return sum};Bit.prototype.rupperBound=function(val){var h,k,l;l=0;h=this.countMax-2;while(l<h){k=Math.floor((l+h)/2);if(this.getSum(k)<val){l=k+1}else{h=k-1}}return l};Bit.prototype.upperBound=function(val){var h,k,l;l=0;h=this.countMax-2;while(l<h){k=Math.floor((l+h)/2);if(this.getSum(k)<=val){l=k+1}else{h=k-1}}return l};return Bit}();window.SmartList=function(superClass){extend(SmartList,superClass);SmartList.prototype.numberOfRows=function(){return 0};SmartList.prototype.heightOfRowAt=function(index){return 0};SmartList.prototype.contentOfRowAt=function(index){return""};SmartList.prototype.root=document;SmartList.prototype.afterLoad=function(dom){};SmartList.prototype.countMax=1e4;SmartList.prototype.bufferLength=3;SmartList.prototype.refresh=function(){var firstIndex,firstShownIndex,i,j,lastIndex,m,ref,ref1,ref2,ref3,viewPort;this.updateNumberOfRows();viewPort=this.constructor.viewPort();firstShownIndex=this.bit.upperBound(viewPort.top);firstIndex=Math.max(firstShownIndex-this.bufferLength,0);lastIndex=Math.min(this.bit.rupperBound(viewPort.bottom)+this.bufferLength,this._data.length);for(i=j=ref=firstIndex,ref1=lastIndex;j<ref1;i=j+=+1){this._data[i].showRefresh(this.contentOfRowAt(i),this.afterLoad,this.heightOfRowAt(i),i<firstShownIndex)}for(i=m=ref2=this.lastPost.begin,ref3=this.lastPost.end;m<ref3;i=m+=+1){if(i<firstIndex||i>=lastIndex){this._data[i].hide()}}return this.lastPost={begin:firstIndex,end:lastIndex}};SmartList.prototype.updateNumberOfRows=function(){var i,j,m,nrows,ref,ref1,ref2,ref3,results,row;nrows=this.numberOfRows();if(nrows>this._data.length){results=[];for(i=j=ref=this._data.length,ref1=nrows;ref<=ref1?j<ref1:j>ref1;i=ref<=ref1?++j:--j){row=new RowWrapper({height:this.heightOfRowAt(i)});this.bit.setValue(i,this.heightOfRowAt(i));this._data.push(row);results.push(this.root.appendChild(row.dom))}return results}else if(nrows<this._data.length){for(i=m=ref2=this._data.length-1,ref3=nrows;m>=ref3;i=m+=-1){this._data[i].remove(this.root)}this._data.splace(nrows,this._data.length-nrows);return this.bit.setValue(i,0)}};SmartList.viewPort=function(){return{top:window.scrollY,bottom:window.scrollY+window.screen.height}};SmartList.prototype.lastPost={begin:0,end:-1};SmartList.prototype._data=[];function SmartList(){SmartList.__super__.constructor.apply(this,arguments);this.bit=new Bit(this.countMax)}return SmartList}(AutoOptions);RowWrapper=function(superClass){extend(RowWrapper,superClass);RowWrapper.prototype.dom=null;RowWrapper.prototype.height=0;function RowWrapper(){RowWrapper.__super__.constructor.apply(this,arguments);this.dom=document.createElement("div");this.dom.style.height=this.height+"px"}RowWrapper.prototype.showRefresh=function(content,callback,height,updateTop){if(height!==this.height){this.dom.style.height=height+"px";if(updateTop){window.scrollY+=height-this.height}this.height=height}if(!this.isShown){this.dom.innerHTML=content;callback(this.dom);return this.isShown=true}};RowWrapper.prototype.hide=function(){if(this.isShown){this.dom.innerHTML=""}return this.isShown=false};RowWrapper.prototype.remove=function(root){this.hide();root.removeChild(this.dom);return this.dom=null};RowWrapper.prototype.isShown=false;return RowWrapper}(AutoOptions)}).call(this);
